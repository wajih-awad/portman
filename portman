#!/bin/bash

# portman - Smart CLI tool to inspect and manage TCP ports

PORT=$1
FORCE=$2

if [ -z "$PORT" ]; then
  echo "‚ùå Usage: portman <port-number> [--force]"
  exit 1
fi

echo "üîç Checking port $PORT..."

# Try lsof first
PID=$(sudo lsof -ti tcp:$PORT 2>/dev/null)

# Fallback to ss if lsof gives nothing
if [ -z "$PID" ]; then
  echo "‚ö†Ô∏è  lsof didn't detect any process. Trying ss..."
  PID=$(sudo ss -lptn "sport = :$PORT" 2>/dev/null | awk 'NR>1 {match($6, /pid=[0-9]+/); if (RSTART) print substr($6, RSTART+4, RLENGTH-4)}')
fi

# Still nothing? Probably TIME_WAIT or released
if [ -z "$PID" ]; then
  echo "üü° Port $PORT appears free, but it may be in TIME_WAIT or recently released."
  echo "‚è≥ Wait a few seconds and try again if the issue persists."
  exit 0
fi

echo "‚ö†Ô∏è Port $PORT is in use by PID: $PID"
echo "‚ÑπÔ∏è Process details:"
sudo lsof -i tcp:$PORT

if [ "$FORCE" == "--force" ]; then
  kill -9 $PID && echo "‚úÖ Process $PID has been killed." || echo "‚ùå Failed to kill process $PID."
  exit 0
fi

read -p "‚ùì Do you want to kill this process? (y/n): " confirm
if [ "$confirm" == "y" ]; then
  kill -9 $PID && echo "‚úÖ Process $PID has been killed." || echo "‚ùå Failed to kill process $PID."
else
  echo "üö´ Aborted. Port $PORT is still in use."
fi
